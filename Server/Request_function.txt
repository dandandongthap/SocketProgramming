#include <fstream>
#include <iostream>
#include <string>
#include <vector>
#include "HTTPRequest.hpp"
#include "json.hpp"

using namespace std;
using namespace nlohmann;

string request(string url)
{
    http::Request req{ url };
    http::Response res = req.send("GET");
    string result = std::string{ res.body.begin(), res.body.end() };
    return result;
}

void get_gold_price() 
{
    string data_str = request("http://tygia.com/json.php");
    stringstream stream;
    stream << data_str;
    json data;
    stream >> data;
	ofstream out("gold.json");
    out << data["golds"][0]["value"];
}

vector<string> get_gold_types()
{
    vector<string> res;
    ifstream in("gold.json");
    json data;
    in >> data;
    for (auto gold_value : data)
    {
        if (find(res.begin(), res.end(), gold_value["type"]) == res.end())
        {
            res.push_back(gold_value["type"]);
        }
    }
    return res;
}

string get_price(string gold_type, string output_type = "buy")
{
    ifstream in("gold.json");
    json data;
    in >> data;
    for (auto gold_value : data)
    {
        if (gold_value["type"] == gold_type)
        {
            return gold_value[output_type];
        }
    }
    return "";
}

int main()
{
    get_gold_price();
    for (string gold_type : get_gold_types())
    {
        cout << gold_type << '\n';
    }
    cout << get_price("SJC");
}